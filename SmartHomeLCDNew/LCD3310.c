#ifndef LCD3310_C
  #define LCD3310_C

#include <avr/io.h>
#include <avr/pgmspace.h>
#include <avr/sleep.h>

#include <string.h>
#include "global.h"
#include "timer.h"

#define SCE    0
#define DC     1
#define SDIN   2
#define CLK    3
#define RST    4


//smart home image stored in rom(opening screen)
const u08 Welup[][8] =
{
 {0x00,0x00,0x00,0x00,0x00,0x00,0x80,0x38},
 {0x24,0x24,0xE4,0x00,0x00,0xE0,0x3C,0xC0},
 {0x70,0x3C,0xC0,0x00,0x80,0xC0,0x70,0x58},
 {0x7C,0xC0,0x00,0x00,0xFC,0x44,0xC4,0xB8},
 {0x00,0x04,0x04,0xFC,0x04,0x04,0x04,0x00},
 {0x00,0x00,0x00,0x00,0xFC,0x20,0x20,0x20},
 {0xFC,0x00,0xF0,0x88,0x04,0x04,0x04,0x84},
 {0x78,0x00,0xE0,0x3C,0xC0,0x70,0x3C,0xC0},
 {0x00,0x00,0xFC,0x24,0x24,0x24,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x01,0x01,0x01,0x01,0x00,0x00},
 {0x00,0x01,0x00,0x01,0x00,0x00,0x01,0x00},
 {0x01,0x00,0x00,0x00,0x80,0xC1,0xE0,0xE0},
 {0xC1,0x80,0x00,0x01,0x00,0x00,0x00,0x01},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x01,0x00,0x00,0x00,0x01,0x00,0x00,0x01},
 {0x81,0x81,0xC1,0xC0,0xC0,0x80,0xC1,0xC0},
 {0x41,0xC0,0xC0,0x01,0x00,0x00,0x01,0x01},
 {0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x10,0x98,0xDC},
 {0xFE,0xFF,0xFF,0xFF,0xFF,0xFE,0xDC,0x98},
 {0x10,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0xC0,0xE0,0xE0,0x30,0x38,0x18},
 {0x0C,0x0E,0x06,0x03,0x03,0x01,0x00,0x00},
 {0x01,0x01,0x03,0x03,0x00,0x0F,0x1F,0x38},
 {0x30,0xE0,0xE0,0xC0,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x00,0xE0,0xE0,0xE0,0xE0},
 {0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0},
 {0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE2},
 {0xE3,0xE3,0xE3,0xE3,0xE3,0xFF,0xFF,0xFF},
 {0xFF,0xE3,0xE3,0xE3,0xE3,0xE3,0xE2,0xE0},
 {0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE3},
 {0xE3,0xFF,0xFF,0x00,0x00,0xFC,0xFC,0xFC},
 {0xFC,0xFC,0x00,0x7C,0x7C,0x7C,0x7C,0x7C},
 {0x7C,0x7C,0x00,0xFF,0xFF,0xE3,0xE3,0xE0},
 {0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0,0xE0},
 {0xE0,0xE0,0xE0,0x00,0x00,0x00,0x00,0x00},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
 {0xFF,0xFF,0xFF,0xFD,0xFD,0xFD,0x7D,0x79},
 {0x39,0x11,0x01,0x01,0x01,0x01,0x01,0x03},
 {0x03,0x03,0x87,0xFF,0xFF,0xFF,0xFF,0xFF},
 {0xFF,0xFF,0xFF,0xFF,0xE7,0xC7,0xC3,0x80},
 {0x98,0x9F,0x9F,0x9F,0x1F,0x3F,0x3C,0x3C},
 {0x3C,0x3C,0x3C,0x7C,0x7C,0x7C,0x7C,0x7F},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00},
 {0x00,0x00,0x00,0x00,0x07,0x07,0x07,0x07},
 {0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07},
 {0x07,0x03,0x03,0x03,0x03,0x01,0x01,0x01},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
 {0x00,0x00,0x00,0x04,0x06,0x07,0x07,0x07},
 {0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07},
 {0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07},
 {0x07,0x07,0x07,0x07,0x06,0x06,0x00,0x00},
 {0x00,0x00,0x00,0x00,0x00,0x00,0x01,0x01},
 {0x07,0x07,0x07,0x07,0x07,0x07,0x07,0x07},
 {0x07,0x07,0x07,0x00,0x00,0x00,0x00,0x00},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
 {0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF},
};


//Fonts look up table
const u08 FontLookup[][5] =
{

    {0x00, 0x00, 0x00, 0x00, 0x00},  //sp0
	{0x00, 0x00, 0x2f, 0x00, 0x00},	// !		33
	{0x00, 0x07, 0x00, 0x07, 0x00},	// "
	{0x14, 0x7f, 0x14, 0x7f, 0x14},	// #
	{0x24, 0x2a, 0x7f, 0x2a, 0x12},	// $
	{0xc4, 0xc8, 0x10, 0x26, 0x46},	// %
	{0x36, 0x49, 0x55, 0x22, 0x50},	// &
	{0x00, 0x05, 0x03, 0x00, 0x00},	// '
	{0x00, 0x1c, 0x22, 0x41, 0x00},	// (
	{0x00, 0x41, 0x22, 0x1c, 0x00},	// )
	{0x14, 0x08, 0x3E, 0x08, 0x14},	// *
	{0x08, 0x08, 0x3E, 0x08, 0x08},	// +
	{0x00, 0x00, 0x50, 0x30, 0x00},	// ,
	{0x10, 0x10, 0x10, 0x10, 0x10},	// -
	{0x00, 0x60, 0x60, 0x00, 0x00},	// .
	{0x20, 0x10, 0x08, 0x04, 0x02},	// /
	{0x3E, 0x51, 0x49, 0x45, 0x3E},	// 0		48
	{0x00, 0x42, 0x7F, 0x40, 0x00},	// 1
	{0x42, 0x61, 0x51, 0x49, 0x46},	// 2
	{0x21, 0x41, 0x45, 0x4B, 0x31},	// 3
	{0x18, 0x14, 0x12, 0x7F, 0x10},	// 4
	{0x27, 0x45, 0x45, 0x45, 0x39},	// 5
	{0x3C, 0x4A, 0x49, 0x49, 0x30},	// 6
	{0x01, 0x71, 0x09, 0x05, 0x03},	// 7
	{0x36, 0x49, 0x49, 0x49, 0x36},	// 8
	{0x06, 0x49, 0x49, 0x29, 0x1E},	// 9		56
	{0x00, 0x36, 0x36, 0x00, 0x00},	// :
	{0x00, 0x56, 0x36, 0x00, 0x00},	// ;
	{0x08, 0x14, 0x22, 0x41, 0x00},	// <
	{0x14, 0x14, 0x14, 0x14, 0x14},	// =
	{0x00, 0x41, 0x22, 0x14, 0x08},	// >
	{0x02, 0x01, 0x51, 0x09, 0x06},	// ?
	{0x32, 0x49, 0x59, 0x51, 0x3E},	// @
	{0x7E, 0xA,  0xA,  0xA, 0x7E}, //A

 //   {0x7E, 0x6A, 0x6A, 0x6A, 0x7E}, //B
    {0x42, 0x7e, 0x4A, 0x4A, 0x76}, //B

    {0x7E, 0x62, 0x62, 0x62, 0x22}, //C
//    {0x7E, 0x62, 0x62, 0x62, 0x3E}, //D
    {0x42, 0x7e, 0x42, 0x24, 0x18}, //D

    {0x7E, 0x6A, 0x6A, 0x6A, 0x28}, //E
    {0x7E, 0xA, 0xA, 0xA, 0xA}, //F

    {0x3c, 0x42, 0x4a, 0x6A, 0x3A}, //G

    {0x7E, 0x8, 0x8, 0x8, 0x3E}, //H
    {0x0, 0x0, 0x7E, 0x0, 0x0}, //I
    {0x60, 0x40, 0x40, 0x40, 0x7E}, //J
 //   {0x7E, 0x8, 0x8, 0x8, 0x72}, //K
    {0x7E, 0x08, 0x14, 0x22, 0x40}, //K

    {0x7E, 0x40, 0x40, 0x40, 0x40}, //L
    {0x7E, 0x2, 0x7E, 0x2, 0x3E}, //M
    {0x7E, 0x2, 0x2, 0x2, 0x3E}, //N

//    {0x7E, 0x62, 0x62, 0x62, 0x3E}, //O
    {0x3c, 0x42, 0x42, 0x42, 0x3c}, //O

    {0x7E, 0x6A, 0xA, 0xA, 0xE}, //P


//    {0x7E, 0x62, 0x62, 0x62, 0x3E}, //Q
//    {0x7c, 0x42, 0x32, 0x32, 0x4c}, //Q
	{0x3c, 0x42, 0x52, 0x22, 0x5c},	// Q

    {0x7E, 0xA, 0xA, 0x1A, 0x6E}, //R
    {0x6E, 0x6A, 0x6A, 0x6A, 0x7A}, //S
    {0x2, 0x2, 0x3E, 0x2, 0x2}, //T
    {0x7E, 0x60, 0x60, 0x60, 0x3E}, //U
//    {0x7E, 0x60, 0x60, 0x78, 0x6}, //V
//    {0x06, 0x38, 0x40, 0x38, 0x06}, //V
    //{0x06, 0x78, 0x60, 0x78, 0x6}, //V
    {0x1e, 0x20, 0x40, 0x20, 0x1e},	// V
    {0x7E, 0x60, 0x7E, 0x60, 0x3E}, //W
 //   {0x7E, 0x8, 0x8, 0x8, 0x72}, //X
//    {0x7E, 0x8, 0x8, 0x8, 0x72}, //X
    {0x62, 0x14, 0x08, 0x14, 0x62},	// X
    {0xE, 0x8, 0x78, 0x8, 0xE}, //Y
    {0x7A, 0x6A, 0x6A, 0x6A, 0x2E}, //Z  90
	{0x00, 0x7F, 0x41, 0x41, 0x00},	// [
	{0x55, 0x2A, 0x55, 0x2A, 0x55},	// extr
	{0x55, 0x2A, 0x55, 0x2A, 0x55},	// 
	{0x00, 0x41, 0x41, 0x7F, 0x00},	// ]
	{0x04, 0x02, 0x01, 0x02, 0x04},	// ^
	{0x40, 0x40, 0x40, 0x40, 0x40},	// _
	{0x00, 0x01, 0x02, 0x04, 0x00},	// '

//	0x20, 0x54, 0x54, 0x54, 0x78,	// a		97
//	0x7F, 0x48, 0x44, 0x44, 0x38,	// b
//	0x38, 0x44, 0x44, 0x44, 0x20,	// c
//	0x38, 0x44, 0x44, 0x48, 0x7F,	// d
//	0x38, 0x54, 0x54, 0x54, 0x18,	// e
//	0x08, 0x7E, 0x09, 0x01, 0x02,	// f
//	0x0C, 0x52, 0x52, 0x52, 0x3E,	// g
//	0x7F, 0x08, 0x04, 0x04, 0x78,	// h
//	0x00, 0x44, 0x7D, 0x40, 0x00,	// i
//	0x20, 0x40, 0x44, 0x3D, 0x00,	// j
//	0x7F, 0x10, 0x28, 0x44, 0x00,	// k
//	0x00, 0x41, 0x7F, 0x40, 0x00,	// l
//	0x7C, 0x04, 0x18, 0x04, 0x78,	// m
//	0x7C, 0x08, 0x04, 0x04, 0x78,	// n
//	0x38, 0x44, 0x44, 0x44, 0x38,	// o
//	0x7C, 0x14, 0x14, 0x14, 0x08,	// p
//	0x08, 0x14, 0x14, 0x18, 0x7C,	// q
//	0x7C, 0x08, 0x04, 0x04, 0x08,	// r
//	0x48, 0x54, 0x54, 0x54, 0x20,	// s
//	0x04, 0x3F, 0x44, 0x40, 0x20,	// t
//	0x3C, 0x40, 0x40, 0x20, 0x7C,	// u
//	0x1C, 0x20, 0x40, 0x20, 0x1C,	// v
//	0x3C, 0x40, 0x30, 0x40, 0x3C,	// w
//	0x44, 0x28, 0x10, 0x28, 0x44,	// x
//	0x0C, 0x50, 0x50, 0x50, 0x3C,	// y
//	0x44, 0x64, 0x54, 0x4C, 0x44	// z

};
//indication image for on off
const u08 onoff[2][5]={ { 0x22,0x14,0x18,0x24,0x42 },
						{ 0x10,0x20,0x60,0x18,0x06 } };


//microsec delay
void delaym(int us)
{
  int delay_loops; 
   register int i;

   delay_loops=(us+3)/5*CYCLES_PER_US;
   for(i=0;i<delay_loops;i++) {};
}

//millisec delay
void delayms(int ms)
{
   int i;
   for(i=0;i<ms;i++) 
    delaym(10);
}




//Fn for datawrite into display
void spi_write(u08 data)
{
   u08 i;
   cbi(PORTA,SCE);

   for(i=8;i;i--)
   {
      if ((data&128))
	    sbi(PORTA,SDIN);
      else
	    cbi(PORTA,SDIN);

      sbi(PORTA,CLK);
	 // delaym(1);
	  cbi(PORTA,CLK);
//	  delaym(1);

	  data<<=1;
   }
   sbi(PORTA,SCE);
}





//Fn to print a string in location (x,y) 
void LCDSTR(char *data,u08 x,u08 y,u08 fl)
{
  u08 i,len=strlen(data);

  LCDGOTOXY(x,y);
  for(;len>0;len--)
  {
    for(i=0;i<=4;i++)
	  spi_write(FontLookup[*data-32][i]);
    data++;
  if(fl==1) spi_write(0x00);
  }
}


//Fn to indicate ON/OFF , YES/NO , En/Dis
//fl --> invert color
void LCDNF(u08 k,u08 x,u08 y,u08 fl)
{
  
  int i; 
  LCDGOTOXY(x,y);
    for(i=0;i<=4;i++)
	  spi_write((fl*0xff) ^ onoff[k][i]);
     spi_write((fl*0xff));
}



//Fn to print the integers directly
//st--> invert color
void LCDDEC(u08 i,u08 st)
{
  u08 k;
  st=st*0xff;
  for(k=0;k<=4;k++)
    spi_write(st^FontLookup[i+16][k]);
}






//Fn to print a u08 
void LCDDIR(u08 i)
{
  u08 k;
  for(k=0;k<=4;k++)
    spi_write(FontLookup[i][k]);
}


//Set the position of cursor
void LCDGOTOXY(u08 x,u08 y)
{
  cbi(PORTA,DC);
  y=y|0x40;
  spi_write(y);
  x=(x*5)|0x80;
  spi_write(x);
  sbi(PORTA,DC);
}

//NO NEED
void LCDEN(char *data,u08 x,u08 y)
{
  u08 i,j,len=strlen(data);
  u08 op[5]={0x18,0x3c,0x7e,0xff,0xff};
  u08 cl[5]={0xff,0xff,0x7e,0x3c,0x18};


   LCDGOTOXY(x,y-1);
  
   for(i=0;i<len*5;i++)
         spi_write(0xc0);
   
 LCDGOTOXY(x-1,y);

 //Open Brace
  for(i=0;i<5;i++)
	  spi_write(op[i]); 
  LCDGOTOXY(x,y);    //menu
 for(j=0;j<len;j++)
  {
    for(i=0;i<=4;i++)
	  spi_write(0xff^FontLookup[*data-32][i]);
	     data++;
  }

//Close Brace
  for(i=0;i<=4;i++)
	  spi_write(cl[i]);

     LCDGOTOXY(x,y+1);

   for(i=0;i<len*5;i++)
         spi_write(0x03);
   

}

//Fn to display highlighted menu
void LCDMEN(char *data,u08 x,u08 y)
{
  u08 i,j,len=strlen(data);

   //menu
 LCDGOTOXY(1,y);
 for(i=5;i<x*5+1;i++)
   	  spi_write(0xff);
  
 for(j=0;j<len;j++)
  {
    for(i=0;i<=4;i++)
	  spi_write(0xff^FontLookup[*data-32][i]);
      spi_write(0xff);
	     data++;
  }
 for(i=len*6+x*5;i<78;i++)
   	  spi_write(0xff);
  

}

//Initialize LCD
void LCDINI()
{
  PORTA=0x00;
  DDRA=0xff;

  PORTC=0x00;
  DDRC=0xff;
  
   cbi(DDRA,4);
  
   delayms(1000);
  sbi(DDRA,0);
  sbi(DDRA,2);
  sbi(DDRA,3);
  sbi(PORTA,4);

  cbi(PORTA,SCE);
  cbi(PORTA,DC);

  spi_write(0x21);
  spi_write(0xc8);
  spi_write(0x06);
  spi_write(0x13);
  spi_write(0x20);
  spi_write(0x0c);

  sbi(PORTA,DC);

}

//Clear the LCD
void LCDCLR()
{
   int i,j;
    for(i=0;i<4;i++)
  	{
	 LCDGOTOXY(1,i+1);
	 for(j=0;j<75;j++)
       spi_write(0x00);

    }    

	 
}

//To print borders alone
void LCDBRD()
{
  u08 i;
  	
	
	LCDGOTOXY(0,0);
	for(i=0;i<84;i++) 
	  spi_write(0x03);


    LCDGOTOXY(0,5);
    for(i=0;i<84;i++)
      spi_write(0xc0);

	for(i=0;i<6;i++) 
	{
	   LCDGOTOXY(0,i);
	   spi_write(0xff);
	   spi_write(0xff);
    }
	
	for(i=0;i<6;i++) 
	{
	   LCDGOTOXY(16,i);
	   if(i!=0 && i!=5)
	   {
	    spi_write(0x00);
	    spi_write(0x00);
	   }
	   else if(i==0)
	   {
	    spi_write(0x03);
	    spi_write(0x03);
	   }
	   else
	   {
	    spi_write(0xc0);
	    spi_write(0xc0);
	   }

 
	   spi_write(0xff);
	   spi_write(0xff);
    }
}

#endif
